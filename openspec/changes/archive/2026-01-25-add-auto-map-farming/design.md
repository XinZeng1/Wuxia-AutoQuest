# Design: 游戏自动刷图功能

## Context
这是一个手机游戏的自动化工具，需要通过图像识别和UI自动化来实现自动刷图功能。游戏界面包含地图探索、战斗等场景。**MVP版本专注于核心的地图探索和导航功能，战斗系统会自动进行无需操作。**

**部署方式**：游戏通过屏幕镜像软件（如Scrcpy、AirDroid等）将手机画面投射到电脑屏幕上，自动化程序在电脑上运行，通过屏幕截图和鼠标点击来控制游戏。

## Goals / Non-Goals

### Goals (MVP)
- 实现无人值守的自动地图探索
- 自动识别地图路径并控制角色移动
- 自动检测怪物并导航到怪物位置触发战斗
- 监控探索进度
- 等待战斗自动完成并继续探索

### Non-Goals (MVP)
- 不实现战斗操作（战斗会自动进行）
- 不实现奖励收集（MVP阶段暂不需要）
- 不修改游戏客户端（纯外部自动化）
- 不实现复杂的AI决策（使用简单规则）
- 不处理网络连接问题（假设游戏正常运行）
- 不实现多账号管理（单账号自动化）

## Decisions

### Decision: 使用电脑屏幕截图和鼠标控制
**原因**: 
- 游戏通过屏幕镜像投射到电脑，可以直接从电脑屏幕截图
- 使用鼠标点击模拟触摸操作，实现简单
- 不需要连接手机或使用ADB等工具
- 跨平台兼容性好（Windows/Mac/Linux都支持）

**替代方案**: 
- ADB自动化：需要USB连接和开发者模式，复杂度高
- Appium：需要额外配置，对MVP阶段过于复杂
- 内存读取：需要逆向工程，维护成本高

### Decision: 使用图像识别而非内存读取
**原因**: 
- 游戏可能是加密的，内存读取困难
- 图像识别更通用，适用于不同游戏版本
- 不需要root权限或特殊权限

**替代方案**: 
- 内存读取：需要逆向工程，维护成本高
- 网络抓包：需要解密协议，复杂度高

### Decision: 使用模板匹配和OCR进行识别
**原因**:
- 模板匹配适合识别固定UI元素（按钮、图标）
- OCR适合识别动态文本（等级、探索度）
- 两者结合可以覆盖大部分识别需求

**替代方案**:
- 深度学习：需要大量训练数据，开发周期长
- 特征点匹配：对UI变化敏感，稳定性差

### Decision: 采用状态机模式管理流程
**原因**:
- 游戏有明确的状态转换（探索 -> 战斗等待 -> 继续探索）
- 状态机便于管理和调试
- 易于扩展新状态

**替代方案**:
- 事件驱动：对于线性流程过于复杂
- 命令模式：状态管理不够清晰

### Decision: MVP阶段简化怪物检测（仅位置，不识别等级名称）
**原因**:
- MVP专注于核心功能验证
- 位置检测足够用于导航到怪物
- 等级和名称识别可以后续添加

**替代方案**:
- 完整识别：增加开发复杂度，MVP阶段不必要

### Decision: 使用配置文件管理游戏数据
**原因**:
- 不同地图、怪物需要不同配置
- 便于适配游戏更新
- 用户可自定义策略

**替代方案**:
- 硬编码：不灵活，难以维护
- 数据库：对于静态配置过于复杂

## Risks / Trade-offs

### Risk: 游戏UI更新导致识别失败
**缓解措施**: 
- 使用相对坐标而非绝对坐标
- 提供配置界面让用户更新模板
- 实现多版本模板支持

### Risk: 屏幕镜像窗口位置或大小变化
**缓解措施**: 
- 支持配置镜像窗口的位置和大小
- 自动检测镜像窗口位置（如果可能）
- 使用相对坐标而非绝对坐标
- 提供窗口区域选择功能

### Risk: 识别准确率不足
**缓解措施**:
- 多次尝试机制
- 置信度阈值设置
- 人工验证模式

### Risk: 执行速度慢
**缓解措施**:
- 优化图像处理算法
- 缓存识别结果
- 并行处理非依赖操作

### Trade-off: 准确率 vs 速度
- 更严格的匹配阈值提高准确率但降低速度
- 方案：提供配置选项让用户选择

## Migration Plan
N/A - 这是新功能，不涉及迁移

## Open Questions
1. 是否需要支持多设备（不同分辨率）？**MVP阶段：单设备即可**
2. 是否需要支持游戏更新后的自动适配？**MVP阶段：手动更新模板**
3. 是否需要提供可视化配置界面？**MVP阶段：配置文件即可**
4. 战斗等待的超时时间设置？**需要测试确定合理值**
5. 屏幕镜像窗口的检测方式？**手动配置窗口区域 vs 自动检测**
